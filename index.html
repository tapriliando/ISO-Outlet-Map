<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DKI Outlet Mapping</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        body {
            margin: 0;
            padding: 0;
        }
        .info {
            padding: 10px 15px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 8px;
            min-width: 150px;
        }
        .info h4 {
            margin: 0 0 10px;
            color: #333;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            padding-bottom: 5px;
            border-bottom: 2px solid #eee;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 4px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid #000;
        }
        .legend-label {
            font-size: 13px;
            color: #555;
        }
        .outlet-label {
            font-size: 9px;
            font-weight: bold;
            text-shadow: 
                -1px -1px 0 #fff,
                1px -1px 0 #fff,
                -1px 1px 0 #fff,
                1px 1px 0 #fff;
            background: rgba(255, 255, 255, 0.7);
            padding: 1px 3px;
            border-radius: 2px;
            white-space: nowrap;
        }
        .location-label {
            background: white;
            padding: 2px 5px;
            border-radius: 3px;
            border: 1px solid #666;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://veecoqwjxnjxgbfymhmu.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlZWNvcXdqeG5qeGdiZnltaG11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDExNDcwODcsImV4cCI6MjA1NjcyMzA4N30.35XG4rT9F0pUQGcCjJkBnZLnx7MHJzf6FNLD6_LKofM'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        // Initialize the map
        const map = L.map('map').setView([-0.058, 109.36], 13);  // Centered at Pontianak

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // Add CSS for labels
        const style = document.createElement('style');
        style.textContent = `
            .location-label {
                background: white;
                padding: 2px 5px;
                border-radius: 3px;
                border: 1px solid #666;
                font-size: 12px;
                font-weight: bold;
                white-space: nowrap;
            }
        `;
        document.head.appendChild(style);

        // Create custom green marker icon
        const greenIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // === MARKERS START ===
        L.marker([-0.07221665995798951, 109.36391512966416]).addTo(map).bindPopup(`
            <b>Alt 1</b><br>
            <img src="images/alt 1 Pontianak.jpg" width="150"><br>
            <pre>Harga : 130jt/th
Tanah : 252 m2
Bangunan : 486m2
Ket : 3 Lantai</pre>
        `).bindTooltip('Alt 1', {permanent: true, className: 'location-label', direction: 'top'});

        L.marker([-0.08701032952512443, 109.36946473170417]).addTo(map).bindPopup(`
            <b>Alt 2</b><br>
            <img src="images/alt 2 Pontianak.jpg" width="150"><br>
            <pre>Harga : -
Tanah : -
Bangunan : -
Ket : 3 Lantai</pre>
        `).bindTooltip('Alt 2', {permanent: true, className: 'location-label', direction: 'top'});

        L.marker([-0.07272884562093689, 109.36392702245597]).addTo(map).bindPopup(`
            <b>Alt 3</b><br>
            <img src="images/alt 3 Pontianak.jpg" width="150"><br>
            <pre>Harga : 300jt/th
Tanah : 250m2
Bangunan : 540m2
Ket : 3 Lantai</pre>
        `).bindTooltip('Alt 3', {permanent: true, className: 'location-label', direction: 'top'});

        L.marker([-0.11862872299666756, 109.3947164419778]).addTo(map).bindPopup(`
            <b>Alt 4</b><br>
            <img src="images/alt 4 Pontianak.jpg" width="150"><br>
            <pre>Harga : 90jt/ruko/th
Tanah : 155m2
Bangunan : 160m2
Ket : 3 Lantai</pre>
        `).bindTooltip('Alt 4', {permanent: true, className: 'location-label', direction: 'top'});

        L.marker([-0.06424591350180463, 109.36863982920569]).addTo(map).bindPopup(`
            <b>Alt 5</b><br>
            <img src="images/alt 5 Pontianak.jpg" width="150"><br>
            <pre>Harga : 250jt/th
Tanah : 900m2
Bangunan : 1800m2
Ket : 3 Lantai</pre>
        `).bindTooltip('Alt 5', {permanent: true, className: 'location-label', direction: 'top'});

        L.marker([-0.033884744471632554, 109.34630861172738]).addTo(map).bindPopup(`
            <b>Alt 6</b><br>
            <img src="images/alt 6 Pontianak.jpg" width="150"><br>
            <pre>Harga : 380jt/th
Tanah : -
Bangunan : -
Ket : 2 Lantai</pre>
        `).bindTooltip('Alt 6', {permanent: true, className: 'location-label', direction: 'top'});

        L.marker([-0.0399902756530726, 109.34727944989758]).addTo(map).bindPopup(`
            <b>Alt 7</b><br>
            <img src="images/alt 7 Pontianak.jpg" width="150"><br>
            <pre>Harga : 200jt/th
Tanah : 576 m2
Bangunan : 972m2
Ket : 3 Lantai</pre>
        `).bindTooltip('Alt 7', {permanent: true, className: 'location-label', direction: 'top'});

        L.marker([-0.014944122008717723, 109.36318976631361]).addTo(map).bindPopup(`
            <b>Alt 8</b><br>
            <img src="images/alt 8 Pontianak.jpg" width="150"><br>
            <pre>Harga : 
Tanah : 
Bangunan : 
Ket : 2 Lantai</pre>
        `).bindTooltip('Alt 8', {permanent: true, className: 'location-label', direction: 'top'});

        L.marker([-0.015302595609699378, 109.36209765045452]).addTo(map).bindPopup(`
            <b>Alt 9</b><br>
            <img src="images/alt 9 Pontianak.jpg" width="150"><br>
            <pre>Harga : 
Tanah : 
Bangunan : 
Ket : 2 Lantai</pre>
        `).bindTooltip('Alt 9', {permanent: true, className: 'location-label', direction: 'top'});

        L.marker([-0.025493869577442065, 109.36931628187571], {icon: greenIcon}).addTo(map).bindPopup(`
            <b>Alt 10</b><br>
            <img src="images/alt 10 Pontianak.jpg" width="150"><br>
            <pre>Harga : 270jt/tahun
Tanah : -  
Bangunan : - 
Ket : 2 Lantai</pre>
        `).bindTooltip('Alt 10', {permanent: true, className: 'location-label', direction: 'top'});

        L.marker([-0.025940635389345088, 109.37717801617963]).addTo(map).bindPopup(`
            <b>Alt 11</b><br>
            <img src="images/alt 11 Pontianak.jpg" width="150"><br>
            <pre>Harga : 150jt/tahun
Tanah : 581m2
Bangunan : 480m2
Ket : 2 Lantai</pre>
        `).bindTooltip('Alt 11', {permanent: true, className: 'location-label', direction: 'top'});

        L.marker([-0.026699044659375858, 109.37972614954057]).addTo(map).bindPopup(`
            <b>Alt 12</b><br>
            <img src="images/alt 12 Pontianak.jpg" width="150"><br>
            <pre>Harga : 90jt/tahun
Tanah : 
Bangunan : 
Ket : 2 Lantai</pre>
        `).bindTooltip('Alt 12', {permanent: true, className: 'location-label', direction: 'top'});

        L.marker([-0.09348768994540307, 109.37571865964155], {icon: greenIcon}).addTo(map).bindPopup(`
            <b>Alt 13</b><br>
            <img src="images/alt 13 Pontianak.jpg" width="150"><br>
            <pre>Harga : 260jt/tahun
Tanah : 
Bangunan : 
Ket : 3 Lantai</pre>
        `).bindTooltip('Alt 13', {permanent: true, className: 'location-label', direction: 'top'});

        L.marker([-0.03986772722215488, 109.34841035210307], {icon: greenIcon}).addTo(map).bindPopup(`
            <b>Alt 14</b><br>
            <img src="images/alt 14 Pontianak.jpg" width="150"><br>
            <pre>Harga : 200jt/tahun
Tanah : 
Bangunan : 
Ket : 1 ruko 3 lantai dan 2 ruko 1 lantai</pre>
        `).bindTooltip('Alt 14', {permanent: true, className: 'location-label', direction: 'top'});

        L.marker([-0.08102330945628582, 109.36788750690728], {icon: greenIcon}).addTo(map).bindPopup(`
            <b>Alt 15</b><br>
            <img src="images/alt 15 Pontianak.jpg" width="150"><br>
            <pre>Harga : 125jt/ruko/tahun
Tanah : 210 m2
Bangunan : 156 m2
Ket : 1 ruko 1 lantai (gudang)</pre>
        `).bindTooltip('Alt 15', {permanent: true, className: 'location-label', direction: 'top'});

        // === MARKERS END ===

        // Store markers and labels for each outlet
        const outletMarkers = new Map();

        // Type configuration
        const typeConfig = {
            'Astra': {
                color: '#377eb8', // Blue
                zIndex: 1
            },
            'Dealer': {
                color: '#e41a1c', // Red
                zIndex: 3
            },
            'POS': {
                color: '#ffff33', // Yellow
                zIndex: 2
            }
        };

        // Function to calculate radius in meters (2 kilometers)
        function getRadius() {
            return 2000; // 2 kilometers in meters
        }

        // Function to add or update outlet on the map
        function addOrUpdateOutlet(outlet) {
            // Remove existing markers if they exist
            if (outletMarkers.has(outlet.id)) {
                const existingMarkers = outletMarkers.get(outlet.id);
                existingMarkers.circle.remove();
                existingMarkers.label.remove();
            }

            const config = typeConfig[outlet.type] || { color: '#999999', zIndex: 0 };

            // Add circle marker with fixed radius
            const circle = L.circle([outlet.lat, outlet.lng], {
                radius: getRadius(),
                fillColor: config.color,
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8,
                pane: 'markerPane' // Use markerPane for better z-index control
            })
            .bindPopup(`<b>${outlet.name}</b><br>Type: ${outlet.type}<br>Sales Volume: ${outlet.sales}<br>Contribution: ${outlet.contrib}`)
            .addTo(map);

            // Set z-index based on type
            circle.setStyle({ zIndex: config.zIndex });

            // Add permanent label
            const label = L.marker([outlet.lat, outlet.lng], {
                icon: L.divIcon({
                    className: 'outlet-label',
                    html: outlet.name,
                    iconSize: [100, 20],
                    iconAnchor: [50, 10]
                }),
                zIndexOffset: config.zIndex * 1000
            }).addTo(map);

            // Store the markers
            outletMarkers.set(outlet.id, { circle, label });
        }

        // Function to remove outlet from the map
        function removeOutlet(outletId) {
            if (outletMarkers.has(outletId)) {
                const markers = outletMarkers.get(outletId);
                markers.circle.remove();
                markers.label.remove();
                outletMarkers.delete(outletId);
            }
        }

        // Add legend
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = '<h4>Outlet Types</h4>';

            // Create legend items
            const types = [
                { name: 'Astra', color: '#377eb8' },
                { name: 'Dealer', color: '#e41a1c' },
                { name: 'POS', color: '#ffff33' }
            ];

            types.forEach(type => {
                const item = L.DomUtil.create('div', 'legend-item', div);
                const colorBox = L.DomUtil.create('div', 'legend-color', item);
                colorBox.style.backgroundColor = type.color;
                const label = L.DomUtil.create('span', 'legend-label', item);
                label.textContent = type.name;
            });

            return div;
        };
        legend.addTo(map);

        // Initial fetch of outlets
        async function fetchAndDisplayOutlets() {
            try {
                const { data: outlets, error } = await supabase
                    .from('outlets')
                    .select('*');

                if (error) throw error;

                // Clear existing markers
                outletMarkers.forEach((markers) => {
                    markers.circle.remove();
                    markers.label.remove();
                });
                outletMarkers.clear();

                // Sort outlets by type to ensure proper layering
                const sortedOutlets = [...outlets].sort((a, b) => {
                    const typeOrder = { 'POS': 3, 'Dealer': 2, 'Astra': 1 };
                    return typeOrder[a.type] - typeOrder[b.type];
                });

                // Add each outlet to the map in sorted order
                sortedOutlets.forEach(outlet => {
                    addOrUpdateOutlet(outlet);
                });
            } catch (error) {
                console.error('Error fetching outlets:', error.message);
            }
        }

        // Set up real-time subscription
        function setupRealtimeSubscription() {
            const subscription = supabase
                .channel('outlets_changes')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'outlets' 
                    }, 
                    (payload) => {
                        console.log('Change received!', payload);
                        
                        switch (payload.eventType) {
                            case 'INSERT':
                            case 'UPDATE':
                                // Remove and re-add all markers to maintain proper order
                                fetchAndDisplayOutlets();
                                break;
                            case 'DELETE':
                                removeOutlet(payload.old.id);
                                break;
                        }
                    }
                )
                .subscribe();
        }

        // Function to add POIs from CSV
        async function addPOIsFromCSV() {
            try {
                console.log('Attempting to load POIs from CSV...');
                const response = await fetch('Alternatif Lokasi Pontianak.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                console.log('CSV loaded successfully:', csvText.substring(0, 200) + '...');
                
                // Parse CSV (skip header)
                const lines = csvText.split('\n').slice(1);
                console.log('Number of POIs found:', lines.length);
                
                lines.forEach((line, index) => {
                    if (!line.trim()) return; // Skip empty lines
                    
                    try {
                        const [name, coordinate, imageUrl, desc] = line.split(';');
                        console.log(`Processing POI ${index + 1}:`, { name, coordinate, imageUrl });
                        
                        const [lat, lng] = coordinate.split(',').map(coord => parseFloat(coord.trim()));
                        if (isNaN(lat) || isNaN(lng)) {
                            console.error(`Invalid coordinates for ${name}:`, coordinate);
                            return;
                        }
                        
                        // Create marker with popup
                        const marker = L.marker([lat, lng])
                            .addTo(map)
                            .bindPopup(`
                                <b>${name}</b><br>
                                <img src="${imageUrl}" alt="${name}" width="150"><br>
                                <pre>${desc}</pre>
                            `);
                        console.log(`Marker added for ${name} at [${lat}, ${lng}]`);
                    } catch (lineError) {
                        console.error(`Error processing line ${index + 1}:`, lineError);
                    }
                });
            } catch (error) {
                console.error('Error loading POIs:', error);
            }
        }

        // Call the function to add POIs
        addPOIsFromCSV();

        // Initialize the map
        fetchAndDisplayOutlets();
        setupRealtimeSubscription();
    </script>
</body>
</html> 